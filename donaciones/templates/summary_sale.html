{% extends "base.html" %}

{% block title %}Resumen de compras{% endblock %}

{% block content %}
	<div class="contenedor z-depth-3 white">
		<a class="right-align secondary-content btn" href="#"><i class="material-icons">clear</i></a>
		<h6>Fecha: {{entry.last_entry|date:"d/m/Y"}}</h6>
		<h4 class="center-align">Bono Contribución Ropero Familiar</h4>
		<table class="highlight z-depth-2">
	    <thead class="grey lighten-3">
	      <tr>
	          <th>Producto</th>
	          <th>Cantidad</th>
	          <th>Precio</th>
	      </tr>
	    </thead>

	    <tbody class="grey lighten-4">
	    	{% for det in details %}
		      <tr class="collection" id="tr_{{ det.id }}">
		        <td>{{det.product_type}}</td>
		        <td>{{ det.quantity|floatformat }} {{det.unit_measure}}</td>
		        <td>$ {{det.total}}  <a href="#modal{{det.id}}" class="modal-trigger right-align secondary-content btn"><i class="material-icons">delete</i></a></td>
		      </tr>

				  <!-- Modal Structure delete sale -->
				  <div id="modal{{det.id}}" class="modal">
				    <div class="modal-content">
				      <h4>Eliminar Detalle de venta</h4>
				      <h6>¿Desea eliminar del <i class="tiny material-icons">shopping_cart</i>: {{det.product_type}} - {{det.quantity}} {{det.unit_measure}}?</h6>
				    </div>
				    <div class="modal-footer">
				    	<a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancelar</a>
				    	<button onclick="deleteSale('{{ det.id }}')" class="modal-close waves-effect waves-green btn-flat">Aceptar</button>
				    </div>
				  </div>

				  <script type="text/javascript">
	          //Desactiva el btn siguiente si no hay tipos de donaciones
	          function btnDisabled(){
	            var items = document.getElementsByClassName('collection');
	            console.log(items.length);
	            if(items.length == 0) {
	              $("#btn_fin").attr('disabled', 'disabled');
	            } else {
	              $("#btn_fin").removeAttr("disabled");
	            }
	          }

	          function deleteSale(saleTypeId) {
	            var request = $.ajax({
	                type: "POST",
	                url: "{% url 'delete_sale' %}",
	                data: {
	                    "csrfmiddlewaretoken": "{{ csrf_token }}",
	                    "sale_type_id": saleTypeId                    
	                },
	            });
	            request.done(function(response) {
	              // Elimina sin actualizar el tipo de venta eliminado.
	              $(document).ready(function() {
	                $("tr#tr_"+response["type_id"]).remove();
	                btnDisabled();
	              });
	            });
	          }
	        </script>
	    	{% endfor %}
	    </tbody>
	  </table>
	  <div class="input-field">
      <span class="helper-text" data-error="wrong" data-success="right">Presionar en <i class="tiny material-icons">clear</i> para cancelar venta</span>
      <span class="helper-text" data-error="wrong" data-success="right">Presionar en <i class="tiny material-icons">delete</i> para eliminar</span>
    </div>
	  <div class="row">
  		<a href="{% url 'sale_detail' entry.id %}" class="btn waves-effect waves-light green darken-1"><i class="material-icons">add</i></a>
  		<span>Agregar un nuevo tipo de venta</span>
	  </div>
		<form method="POST">
		{% csrf_token %} 
			<div class="row">
				<div class="col s12 m8">
					<h5>Colabora:<br> Sr./Sra: {{entry.family.firstname}}, {{entry.family.lastname}}</h5>
				</div>
				<div class="input-field col s12 m4">
					<i class="material-icons prefix">monetization_on</i>
					{{form.total}}
					{{form.total.label_tag}}
					<span class="helper-text" data-error="wrong" data-success="right">Confirmar o editar cantidad</span>
				</div>
			</div>
			<div class="row">
				{% if details %}
					<div class="col m4 s12 offset-m4">
			  		<button id="btn_fin" class="waves-effect waves-light btn-large boton-home" type="submit">Finalizar</button>
			 		</div>
			 	{% else %}
				 	<div class="col m4 s12 offset-m4">
				  	<button id="btn_fin" class="waves-effect waves-light btn-large boton-home disabled" type="submit">Finalizar</button>
				 	</div>
				{% endif %}
			</div>
		</form>
			
	</div>
	
{% endblock %}

{% block extra_js %}
	<script type="text/javascript">
		$(document).ready(function(){
		$('.modal').modal();
		});
	</script>

{% endblock %}